---
title: Запрос схемы базы данных
author: dotnetcoding
type: post
date: 2012-07-25T11:23:18+00:00
url: /coding/zapros-shemy-bazy-danny-h.html
robotsmeta:
  - index,follow
categories:
  - .NET Программирование

---
был приведен пример, демонстрирующий повторное заполнение DataSet из исходного источника данных. При этом была выявлена проблема: при повторении “обновлений&#187; данных DataAdapter добавляет все новые и новые строки, а не обновляет их.
  
<!--more-->


  
Объект DataAdapter не может обнаружить повторяющиеся строки из-за отсутствия информации схемы, которая четко различает первичные ключи и ограничения UniqueKeyConstraints в объектах DataTable внутри DataSet.

Этого можно легко избежать при наличии информации схемы в DataTable. Причем совсем не обязательно задавать эту информацию вручную: в простейших случаях можно запросить всю информацию схемы непосредственно из базы данных. Рассмотрим этот принцип на примере кода упражнения 

1. Вначале создайте новый проект приложения на базе Windows-формы. Назовите его Exercise и замените текст заголовка главной формы на Exercise. Кроме того, добавьте приватную переменную myData типа DataSet.

2. Поместите на главную форму две кнопки. Назовите их buttonSchemd и buttonData и измените текст на них на Fill Schema (Заполнение схемы) и Fill Data (Заполнение данными) соответственно. Кроме того, добавьте элемент WebBrowser и назовите его xmiBrcwser.

В этом примере кнопка buttonScbema будет использована для загрузки из базы данных схемы DataSet; а после загрузки схемы кнопка buttonData будет использована для выборки данных из базы. Кроме того, поскольку элемент DataGn dView не может отображать гтформацию схемы, в этом примере содержимое DataSet отображается непосредственно в XML. Это позволяет просматривать и информацию схемы, и информацию данных, т.е. всю информацию DataSet, непосредственно в XML-виде, загруженную в элемент xmlBrowser.
  
3. В обработчике события щелчка на кнопке buttonData введите код. Этот код не отличается от того, который применялся раньше для заполнения данными. Обратите внимание, что по сравнению с упражнением 7.3 применяется другой перегруженный вариант метода Fill. Теперь при выполнении метода Fill уже не нужно явно указывать имя таблицы. Это происходит потому, что объект DataSet содержит информацию схемы, и нет необходимости явно разбивать данные на две таблицы: DataAdapter может теперь прочитать схему и безошибочно направлять данные в нужные DataTable. (Попробуйте заменить в упражнении вызов Fill (myData, &#171;UserTable&#187;) на Fill (myData) ивы увидите, что пример уже не работает правильно.)
  
6. Скомпилируйте и запустите приложение. Щелкните на кнопке Fill Schema, а потом на кнопке Fill Data. Затем щелкните несколько раз подряд на кнопке Fil) Data — теперь, в отличие от примера (поскольку уже загружена информация схемы), DataAdapter может распознавать повторяющиеся строки и не добавлять их. Это показано (некоторые элементы свернуты, чтобы уменьшить размер изображения, но вы можете запустить соо 1ветству-тощий код с сайта издательства и увидеть все данные).