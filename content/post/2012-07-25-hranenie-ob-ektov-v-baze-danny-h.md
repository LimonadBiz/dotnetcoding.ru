---
title: Хранение объектов в базе данных
author: dotnetcoding
type: post
date: 2012-07-25T10:33:59+00:00
url: /coding/hranenie-ob-ektov-v-baze-danny-h.html
robotsmeta:
  - index,follow
categories:
  - .NET Программирование

---
Microsoft SQL Server 2005 позволяет расширить систему встроенных скалярных типов, создавав пользовательские типы (User-Defined Types — UDT). UDT позволяют созлать непосредственное (value type) или ссылочное (reference type) представление объекта и хранить его непосредственно в базе данных.

> UDT отличаются от хранимой процедуры sp\_addtype, поставлявшейся с SQL Server 2000. UDT позволяют создавать представления объектов в виде типов данных, a sp\_addtype позволяет создавать скалярные типы UDT на основе множества скалярных типов, поддерживаемых SQL Server 

В классе, представляющем объект, наряду с объектным представлением можно сохранять и логику. Например, можно написать класс XYCoOrdinate, одно из свойств которого представляет собой расстояние до начала координат.

В SQL Server ого возможно, т.к. он позволяет хранить CLR. Хранение CLR непосредственно в SQL Server позволяет записывать хранимые процедуры. UDT, определяемые пользователем функции, триггеры и т.д. на любом языке, совместимом с CLR.

В CLR все наоборот

Приложение обычно взаимодействует с CLR с помощью интерфейса iCorRnntimeHost или метода CorBir.dTcRun&#8217;imeSx, который вызывает библиотеку mscoree .dll, а та загружает среду времени выполнения. Затем, благодаря фантастическим возможностям среды времени выполнения .NET жизнь существенно облегчается Этот принцип выполняется в большинстве приложений с несколькими особыми исключениями, одним из которых является SQL Server.

В SQL Server 2005 зстроен несколько другой механизм самозагрузки Во-первых, при отсутствии специального указания он не загружает CLR. Это позволяет сэкономить несколько мегабайтов памяти, которые были бы заняты под CLR. Но даже и при загрузке CLR вместо использования iCLRR_n time Host (замена iCorRuntimeHost в .NET 2.0), а, следовательно в SQL Server 2005 применяется метод iHostCon-rol: : GetHostManager Это переворачивает многое вверх тормашками. Теперь CLR делегирует операции наподобие блокировки ресурсов, управления потоками и тд приложению SQL Server (все наоборот).

Однако наивно предполагать, что CLR выполняется в SQL Server точно так же, как на обычной Windows-машине. Основное различие состоит в том, что SQL Server отвечает за диспетчирование и управление потоками, синхронизацию, блокировки и выделение памяти.

Поскольку CLR в SQL Server выполняется не в таких условиях, как на обычном компьютере, к нему предъявляются другие требования, особенно в области безопасности. Обычно для управляемого кода в SQL Server существуют три категории защиты доступа:

• SAFE — максимальная; действует по умолчанию.

• EXTERNAL_ACCESS — доступны некоторые внешние ресурсы.

• UNSAFE — практически то же самое, что и расширенные хранимые процедуры.

Создание собственных пользовательских типов зависит от аналогичных требований к безопасности.

Кроме того, класс или структура, представляющая UDT, должна быть понятна для SQL Server, чтобы он мог конвертировать ее в байтовый поток (т.е. должна быть сериализуемой — Serializable). Она должна выдавать логическое текстуальное представление, когда входит в состав результатов простого оператора SELECT (ToString ()). И она должна легко вставляться из простой текстовой SQL-команды INSERT (метод Parse, принимающей sqlStnng). Эти и другие методы будут более подробно рассмотрены чуть ниже.
  
Visual Studio 2005 упрощает жизнь, т.к. содержит мастер создания проектов SQL Server. Вот как можно легко создать пользовательский тип в Visual Studio 2005:

1. Создайте в Visual Studio новый проект SQL Server.

2. Добавьте в этот проект новый UDT. Назовите его XYCoOrdinate.

3. Структура пользовательского гипа уже подготовлена для вас.